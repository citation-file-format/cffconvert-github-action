name: selftest
on: # on any PRs and main branch changes
  pull_request:
  push:
    branches:
      - main
      - 'releases/*'

jobs:

  no-args:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Test without any input arguments
          uses: ./

  show-help:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Show help
          uses: ./
          with:
            args: --help

  show-version:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Show version
          uses: ./
          with:
            args: --version

  validate:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Validate a CITATION.cff file from the current directory
          id: step_validate
          uses: ./
          env:
            TEST_OUT: hello world
          with:
            args: --validate
        - name: Check stdout
          run: |
            echo ${{ steps.step_validate.outputs.step_stdout }}
            echo "${{ steps.step_validate.outputs.step_stdout }}"
            if [[ "${{ steps.step_validate.outputs.step_stdout }}" == *"Citation metadata are valid"* ]]; then
                echo "Success"
                exit 0
            else
                echo "Failed"
                exit 1
            fi

  subdirectory:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Validate a CITATION.cff from a subdirectory
          uses: ./
          with:
            args: "--infile ./tests/subdirectory/CITATION.cff --validate"

  convert-to-cff-on-stdout:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Show CITATION.cff from a subdirectory on stdout
          uses: ./
          with:
            args: "--infile ./tests/subdirectory/CITATION.cff -f cff"

  convert-to-zenodo-on-stdout:
      runs-on: ubuntu-latest
      steps:
        - name: Clone this repository
          uses: actions/checkout@v2
        - name: Convert CITATION.cff from a subdirectory to Zenodo metadata format, show result on stdout
          uses: ./
          with:
            args: "--infile ./tests/subdirectory/CITATION.cff -f zenodo"
